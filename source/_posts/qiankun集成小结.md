---
title: qiankun集成小结
date: 2020-05-13 23:11:59
tags:
  - 微前端
---

基于项目的功能模块希望独立升级维护和独立部署，我在项目脚手架中集成了 qiankun 微前端框架。

引进任何一个新技术或者做任何一个技术选型，总是避免不了被人质疑和挑战，尤其是面试和答辩过程。选用基于 single-spa 的 qiankun 微前端框架，而不是用 iframe 来实现，原因总是避免不了解释。

这里我们看看 qiankun 官方的解释。

```
为什么不用 iframe，这几乎是所有微前端方案第一个会被 challenge 的问题。但是大部分微前端方案又不约而同放弃了 iframe 方案，自然是有原因的，并不是为了 "炫技" 或者刻意追求 "特立独行"。
如果不考虑体验问题，iframe 几乎是最完美的微前端解决方案了。
iframe 最大的特性就是提供了浏览器原生的硬隔离方案，不论是样式隔离、js 隔离这类问题统统都能被完美解决。但他的最大问题也在于他的隔离性无法被突破，导致应用间上下文无法被共享，随之带来的开发体验、产品体验的问题。
其实这个问题之前这篇也提到过，这里再单独拿出来回顾一下好了。
1. url 不同步。浏览器刷新 iframe url 状态丢失、后退前进按钮无法使用。
2. UI 不同步，DOM 结构不共享。想象一下屏幕右下角 1/4 的 iframe 里来一个带遮罩层的弹框，同时我们要求这个弹框要浏览器居中显示，还要浏览器 resize 时自动居中..
3. 全局上下文完全隔离，内存变量不共享。iframe 内外系统的通信、数据同步等需求，主应用的 cookie 要透传到根域名都不同的子应用中实现免登效果。
4. 慢。每次子应用进入都是一次浏览器上下文重建、资源重新加载的过程。
其中有的问题比较好解决(问题1)，有的问题我们可以睁一只眼闭一只眼(问题4)，但有的问题我们则很难解决(问题3)甚至无法解决(问题2)，而这些无法解决的问题恰恰又会给产品带来非常严重的体验问题， 最终导致我们舍弃了 iframe 方案。
```

前端在面临日益臃肿的应用开发中，很容易非前端开发人员被忽略其复杂程度。这个复杂度不仅仅是具体某个页面的复杂度，还包括整个应用的维护复杂度和随着时间的延伸带来的升级问题。而微前端架构就是打破巨石应用最好的锤子。微前端架构的优点如下：

- 技术栈无关
- 微应用独立部署
- 微应用独立升级
- 微应用分布式开发
- 独立运行时，运行时状态不共享

天下没有免费的午餐，能解决那么多问题的框架，本身也会有很多细节处理需要我们严肃考虑：

- 公共模块如何规划，以减少主应用集成子应用之后依赖的冗余
- localStorage， window 下的全局状态，如何做好微应用之间的隔离
- 微应用和主应用之间的通讯机制
- js，css 具体怎么实现隔离

在实际落地业务的过程中，我会持续完善优化微前端集成的细节优化。勇于尝试新架构去解决旧问题，然后持续对比和改进方案。
